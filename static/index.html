<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHICOM Media Tracker Bot - Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Load the updated utils script from the root -->
  <script src="/static/assets/js/utils.js?v=20250815"></script>

  <!--Dashboard-->
  <!-- Load the updated dashboard styles directly from the root -->
  <link rel="stylesheet" href="/static/assets/css/dashboard.css?v=20250815" />
</head>

<body>
  <!-- Removed particles background container; background is now defined via CSS -->
  <!-- === LOGIN FORM === -->
  <form id="loginForm" onsubmit="handleLogin(event); return false;">
    <div class="container mt-5" id="loginContainer">
      <h3 id="typingText" class="typing-gradient"></h3>
      <input type="text" id="email" placeholder="admin" class="form-control mb-2" />
      <input type="password" id="password" placeholder="123456" class="form-control mb-3" />
      <button type="submit" class="btn btn-success w-100">Login</button>
    </div>
  </form>
  <div id="dashboardContainer" style="display: none">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <!-- Company logo placed before the brand name for a professional look -->
          <!-- <img src="/static/logo/Chicom_logo.png" alt="Chi Communications Logo" class="company-logo logo--nav me-2" /> -->
          CHICOM Media Tracker
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="javascript:void(0)" id="settingsLink">Settings</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#reportModal"
                onclick="loadReportList()">Reports</a>
            </li>
            <li>
              <button class="btn btn-outline-light btn-sm ms-3" onclick="confirmLogout()">
                <i class="fas fa-sign-out-alt me-1"></i> Logout
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-2 text-center d-none d-md-block">
            <!-- Display the company logo prominently in the hero section -->
            <img src="/static/logo/Chicom_logo.png" alt="Chi Communications Logo" class="company-logo logo--hero" />
          </div>
          <div class="col-md-10">
            <h1 class="display-6 fw-bold mb-2">COMPETITOR REPORT</h1>
            <h2 class="h4 mb-3">PR & SOCIAL MONTHLY REPORT</h2>
            <p class="lead mb-0">
              Automatic media tracking system for Vietnam FMCG industry
            </p>
          </div>
        </div>
      </div>
    </section>

    <div class="container">
      <!-- Status & Controls -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-tachometer-alt me-2"></i>
                Bot Status
              </h5>
            </div>
            <div class="card-body">
              <div class="row align-items-center">
                <style>
                  .label-fixed {
                    min-width: 70px;
                    /* ƒë·ªß cho ch·ªØ "Progress:" kh√¥ng b·ªã wrap */
                    flex-shrink: 0;
                  }
                </style>
                <div class="col-12 col-md-6">
                  <div class="d-flex align-items-center mb-3">
                    <span class="label-fixed me-3">Status:</span>
                    <span id="statusBadge" class="status-badge status-idle" role="status" aria-live="polite">
                      <i class="fas fa-circle-notch me-1"></i>Idle
                    </span>
                  </div>
                  <div class="d-flex align-items-center mb-3">
                    <span class="label-fixed me-3">Task:</span>
                    <span id="currentTask" class="fw-bold fs-6">Waiting to start</span>
                  </div>
                  <div class="progress-wrapper">
                    <span class="label-fixed me-3">Progress:</span>
                    <div class="flex-grow-1">
                      <div class="progress-container">
                        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                      </div>
                    </div>
                    <div class="progress-text-wrapper">
                      <span id="progressText" class="ms-2 fw-bold">0%</span>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="row text-center">
                    <div class="col-4">
                      <div class="metric-number" id="totalSources">0</div>
                      <div class="metric-label">Total Sources</div>
                    </div>
                    <div class="col-4">
                      <div class="metric-number" id="completedSources">0</div>
                      <span class="metric-label">Completed</span>
                    </div>
                    <div class="col-4">
                      <div class="metric-number" id="failedSources">0</div>
                      <div class="metric-label">Failed</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-play me-2"></i>
                Controls
              </h5>
            </div>
            <div class="card-body text-center">
              <button id="runBtn" class="btn btn-primary btn-lg mb-2 w-100">
                <i class="fas fa-play me-2"></i>
                Run Pipeline
              </button>
              <button id="configBtn" class="btn btn-outline-primary mb-2 w-100" onclick="showConfigModal()">
                <i class="fas fa-cog me-2"></i>
                Configure Pipeline
              </button>
              <!-- Cancel & Pause/Resume Buttons Side-by-Side -->
              <!-- N√∫t Cancel v√† Pause n·∫±m ngang, c√πng style -->
              <div class="d-flex justify-content-between gap-2 mb-3">
                <button id="cancelBtn" class="btn btn-outline-danger flex-fill rounded-pill py-2" disabled>
                  <i class="fas fa-ban me-2"></i>Cancel
                </button>

                <button id="pauseResumeBtn" class="btn btn-outline-warning flex-fill rounded-pill py-2"
                  onclick="togglePauseResume()" disabled>
                  <i class="fas fa-pause me-2"></i>Pause
                </button>
              </div>
              <div class="small text-muted">
                <i class="fas fa-clock me-1"></i>
                L·∫ßn ch·∫°y cu·ªëi: <span id="lastRun">Ch∆∞a c√≥</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Overview -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                Summary - Overall
              </h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-12 col-md-6">
                  <p class="mb-2">
                    <strong>Data extraction time:</strong>
                    <span id="dateRange">Loading...</span>
                  </p>
                </div>
                <div class="col-12 col-md-6 text-end">
                  <button class="btn btn-outline-primary btn-sm me-2" onclick="downloadReport('json')">
                    <i class="fas fa-download me-1"></i>JSON
                  </button>
                  <button class="btn btn-outline-primary btn-sm me-2" onclick="downloadReport('excel')">
                    <i class="fas fa-file-excel me-1"></i>Excel
                  </button>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>Ng√†nh h√†ng</th>
                      <th>Nh√£n h√†ng</th>
                      <th>C√°c ƒë·∫ßu b√°o</th>
                      <th>S·ªë l∆∞·ª£ng b√†i</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="summaryTableBody">
                    <tr>
                      <td colspan="5" class="text-center loading-state">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading data...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row mb-4">
        <div class="col-12 col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-pie me-2"></i>
                Ph√¢n b·ªë theo Ng√†nh h√†ng
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="industryChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-line me-2"></i>
                Top Media Sources
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="mediaChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Articles Detail -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">
                <i class="fas fa-newspaper me-2"></i>
                Chi ti·∫øt b√†i b√°o
              </h5>
              <div class="d-flex gap-2">
                <select id="industryFilter" class="form-select form-select-sm" style="width: auto">
                  <option value="">T·∫•t c·∫£ ng√†nh</option>
                </select>
                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="T√¨m ki·∫øm..."
                  style="width: 200px" />
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>STT</th>
                      <th>Ng√†y</th>
                      <th>ƒê·∫ßu b√°o</th>
                      <th>C·ª•m n·ªôi dung</th>
                      <th>T√≥m t·∫Øt</th>
                      <th>Ng√†nh h√†ng</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="articlesTableBody">
                    <tr>
                      <td colspan="7" class="text-center loading-state">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        ƒêang t·∫£i d·ªØ li·ªáu...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Pagination -->
              <nav>
                <ul class="pagination justify-content-center" id="pagination">
                  <!-- Pagination will be generated here -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-history me-2"></i>
                Activity Log
              </h5>
            </div>
            <div class="card-body">
              <div id="activityLog" class="timeline">
                <div class="timeline-item">
                  <div class="fw-bold">System Started</div>
                  <div class="text-muted small">
                    Media Tracker Bot ƒë√£ kh·ªüi ƒë·ªông
                  </div>
                  <div class="text-muted small">
                    <i class="fas fa-clock me-1"></i><span id="startTime"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Article Detail Modal -->
    <div class="modal fade" id="articleModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chi ti·∫øt b√†i b√°o</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="articleContent">
              <!-- Article content will be loaded here -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              ƒê√≥ng
            </button>
            <a id="articleLink" href="#" target="_blank" class="btn btn-primary">Xem b√†i g·ªëc</a>
          </div>
        </div>
      </div>
    </div>

    <div id="loadingScreen">
      <div class="spinner"></div>
      <p>ƒêang t·∫£i...</p>
    </div>

    <!-- Custom JavaScript -->
    <script>
      // Global variables
      let currentReport = null;
      let currentArticles = [];
      let filteredArticles = [];
      let currentPage = 1;
      let articlesPerPage = 20;
      let industryChart = null;
      let mediaChart = null;
      let statusInterval = null;
      let pollingInterval = null;
      let currentSessionId = null;
      let currentConfig = null;
      let displayedProgress = 0;
      let isLoadSettings = false;

      // ==== Pipeline media picker state ====
      const PIPELINE_MAX_MEDIA_SOURCES = 5;
      let PIPELINE_ALL_MEDIA = [];               // [{id, name, domain?}] do BE tr·∫£
      let PIPELINE_SELECTED_MEDIA = new Set();   // id ƒë√£ ch·ªçn

      // ===== LocalStorage keys + helpers =====
      const LS = {
        SOURCES: 'pipeline_selected_sources',
        START: 'pipeline_start_date',
        END: 'pipeline_end_date',
        KW: 'pipeline_custom_keywords',
        UPDATED: 'pipeline_updated_at'
      };

      const ls = {
        getJSON: (k, def = null) => {
          try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch { return def; }
        },
        setJSON: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
        get: (k, def = null) => localStorage.getItem(k) ?? def,
        set: (k, v) => localStorage.setItem(k, v),
        del: (k) => localStorage.removeItem(k),
      };


      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", async () => {
        if (sessionStorage.getItem("reloadAfterLogin") === "1") {
          sessionStorage.removeItem("reloadAfterLogin");
          window.location.reload();
          return;
        }

        const token = localStorage.getItem("token");
        const savedIndustry = localStorage.getItem("ui_filter_industry") || "";
        const savedQuery = localStorage.getItem("ui_filter_q") || "";

        const loginDiv = document.getElementById("loginContainer");
        const dashboardDiv = document.getElementById("dashboardContainer");
        const loadingScreen = document.getElementById("loadingScreen");
        const industryEl = document.getElementById("industryFilter");
        const searchEl = document.getElementById("searchInput");

        // ·∫®n UI, hi·ªán loading
        loginDiv.style.display = "none";
        dashboardDiv.style.display = "none";
        loadingScreen.style.display = "flex";

        if (industryEl) industryEl.value = savedIndustry;
        if (searchEl) searchEl.value = savedQuery;

        // G·ªçi l·∫°i h√†m l·ªçc ƒë·ªÉ ƒë·ªìng b·ªô b·∫£ng ngay sau khi g√°n gi√° tr·ªã
        if (typeof filterArticles === "function") filterArticles();
        else if (typeof updateArticlesTable === "function") updateArticlesTable();

        if (!token) {
          loadingScreen.style.display = "none";
          showLogin();
          loadKeywordConfiguration();
          return;
        }

        try {
          const response = await fetch("/api/tasks", {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
          });
          if (response.ok) {
            // ‚úÖ Token h·ª£p l·ªá
            initializeDashboard();
            await hydrateConfigOnLogin();
            await loadInitialData();
            showDashboard();
            loadKeywordConfiguration(); // v·∫´n load config t·ª´ LS
            setupEventListeners();
            loadingScreen.style.display = "none";
          } else if (response.status === 401) {
            // Token expired
            localStorage.removeItem("token");
            loadingScreen.style.display = "none";
            showLogin();
          } else {
            console.error("Auth check failed:", response.status);
            showLogin(); // ho·∫∑c gi·ªØ dashboard tu·ª≥ √Ω
          }
        } catch (err) {
          console.error("Auth check error:", err);
          // N·∫øu ch·ªâ l·ªói m·∫°ng, v·∫´n gi·ªØ dashboard
          showDashboard();
        }
      });


      document.getElementById("startTime").textContent =
        new Date().toLocaleString("vi-VN");

      async function hydrateConfigOnLogin() {
        // (T√πy ch·ªçn) l·∫•y /api/config ch·ªâ ƒë·ªÉ g·ª£i √Ω selected_sources, dates (KH√îNG ƒë·ª•ng keywords)
        let be = null;
        try {
          const r = await fetch("/api/config", {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
          });
          if (r.ok) be = await r.json();
        } catch { }

        // L·∫•y t·ª´ localStorage
        const lsSources = ls.getJSON(LS.SOURCES, []);
        const lsStart = ls.get(LS.START, null);
        const lsEnd = ls.get(LS.END, null);
        const lsKw = ls.getJSON(LS.KW, null);

        // Merge: sources/dates ∆∞u ti√™n LS n·∫øu c√≥, fallback BE; keywords ch·ªâ d√πng LS
        const merged = {
          selected_sources: lsSources.length ? lsSources : (Array.isArray(be?.selected_sources) ? be.selected_sources : []),
          start_date: lsStart || be?.start_date || null,
          end_date: lsEnd || be?.end_date || null,
          custom_keywords: lsKw || null, // ‚úÖ tuy·ªát ƒë·ªëi kh√¥ng l·∫•y t·ª´ BE
        };

        // Ghi l·∫°i LS + timestamp
        ls.setJSON(LS.SOURCES, merged.selected_sources);
        if (merged.start_date) ls.set(LS.START, merged.start_date);
        if (merged.end_date) ls.set(LS.END, merged.end_date);
        if (merged.custom_keywords) ls.setJSON(LS.KW, merged.custom_keywords);
        ls.set(LS.UPDATED, new Date().toISOString());
      }

      function showLogin() {
        const loginForm = document.getElementById("loginForm");
        const loginContainer = document.getElementById("loginContainer");
        const dashboardContainer =
          document.getElementById("dashboardContainer");

        // ·∫®n dashboard
        dashboardContainer.style.display = "none";
        dashboardContainer.classList.remove("fade-in-down");

        // Reset login container
        loginContainer.style.display = "block";
        loginForm.style.display = "block";
        loginContainer.classList.remove("fade-out-up");
        loginContainer.classList.remove("fade-in-down");

        // Force reflow ƒë·ªÉ reset animation
        void loginContainer.offsetWidth;

        // Th√™m animation xu·∫•t hi·ªán l·∫°i
        loginContainer.classList.add("fade-in-down");

        // Reset input form
        document.getElementById("loginForm").reset();
      }

      function showDashboard() {
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("dashboardContainer").style.display = "block";
      }

      function initializeDashboard() {
        console.log("üöÄ Initializing Media Tracker Dashboard...");
        addActivityLog(
          "Dashboard Initialized",
          "Giao di·ªán ƒëi·ªÅu khi·ªÉn ƒë√£ s·∫µn s√†ng"
        );
      }

      let eventListenersBound = false;

      // Safe binder: ch·ªâ attach n·∫øu element t·ªìn t·∫°i (tr√°nh null.addEventListener)
      function on(id, ev, handler) {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener(ev, handler);
        } else {
          console.debug(`on() skipped: #${id} not found`);
        }
      }

      eventListenersBound = false;
      function setupEventListeners() {
        if (eventListenersBound) return;
        eventListenersBound = true;
        // Run button
        on("runBtn", "click", runPipeline);

        // Stop button - FIXED
        on("cancelBtn", "click", cancelPipeline);

        // Search (ghi LS + debounce)
        const searchEl = document.getElementById("searchInput");
        searchEl?.addEventListener(
          "input",
          debounce((e) => {
            localStorage.setItem("ui_filter_q", e.target.value || "");
            filterArticles();
          }, 300)
        );
      }

      // Industry filter (ghi LS)
      const industryEl = document.getElementById("industryFilter");
      industryEl?.addEventListener("change", (e) => {
        localStorage.setItem("ui_filter_industry", e.target.value || "");
        filterArticles();
      });

      // Settings modal
      const settingsLinkEl = document.querySelector("#settingsLink");
      if (settingsLinkEl) {
        settingsLinkEl.addEventListener("click", async (e) => {
          e.preventDefault();
          document.querySelectorAll('body > .app-overlay').forEach(n => n.remove());
          delete document.body.dataset?.overlayActive;
          showModal("settingsModal");
          const body = document.querySelector("#settingsModal .modal-body");
          try {
            await loadSettings();
          } catch (err) {
            console.error("loadSettings failed:", err);
            toast("Kh√¥ng t·∫£i ƒë∆∞·ª£c c√†i ƒë·∫∑t. Vui l√≤ng th·ª≠ l·∫°i.");
          }
        });
      }

      async function loadInitialData() {
        try {
          showLoadingState();
          await loadLatestReport();
          await loadStatus();
          addActivityLog("Data Loaded", "D·ªØ li·ªáu ban ƒë·∫ßu ƒë√£ ƒë∆∞·ª£c t·∫£i");
        } catch (error) {
          console.error("Error loading initial data:", error);
          addActivityLog("Error", "L·ªói khi t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu", "error");
        }
      }

      // ADDED: Load current config t·ª´ backend
      async function loadCurrentConfig() {
        try {
          const response = await fetch("/api/config", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const config = await response.json();
          currentConfig = config;
          const sel = Array.isArray(config.selected_sources) ? config.selected_sources.length : 0;
          document.getElementById("totalSources").textContent = sel;
          console.log("‚úÖ Config loaded:", config);
        } catch (error) {
          console.error("Error loading config:", error);
        }
      }

      function showLoadingState() {
        const map = {
          summaryTableBody: 5,
          articlesTableBody: 7,
        };
        Object.entries(map).forEach(([id, cols]) => {
          const el = document.getElementById(id);
          if (el) {
            el.innerHTML = `
        <tr>
          <td colspan="${cols}" class="text-center loading-state">
            <i class="fas fa-spinner fa-spin me-2"></i> ƒêang t·∫£i d·ªØ li·ªáu...
          </td>
        </tr>`;
          }
        });
      }

      async function loadLatestReport() {
        try {
          const response = await fetch("/api/reports/latest", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await response.json();

          if (data && data.articles) {
            currentReport = data;
            currentArticles = data.articles;
            filteredArticles = [...currentArticles];

            //Format th·ªùi gian t·∫°o report t·ª´ generated_at
            const generatedAt = new Date(currentReport.generated_at);
            const formattedTime = generatedAt.toLocaleString("vi-VN", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });

            document.getElementById("lastRun").innerText = formattedTime;

            updateSummaryTable();
            updateArticlesTable();
            updateCharts();
            updateDateRange();

            console.log("‚úÖ Report loaded:", data.total_articles, "articles");
          } else {
            console.log("üìÑ No report data available");
            // showSampleData();
          }
        } catch (error) {
          console.error("Error loading report:", error);
          // showSampleData();
        }
      }

      function showSampleData() {
        // Show sample data for demo
        const sampleData = {
          overall_summary: {
            thoi_gian_trich_xuat: "T·ª´ ng√†y 01/12/2024 ƒë·∫øn ng√†y 31/12/2024",
            industries: [
              {
                nganh_hang: "D·∫ßu ƒÉn",
                nhan_hang: ["T∆∞·ªùng An", "Coba", "Nortalic"],
                so_luong_bai: 7,
                cac_dau_bao: ["Vietnam Biz", "VnExpress", "Thanh Nien"],
              },
            ],
            tong_so_bai: 7,
          },
          articles: [
            {
              stt: 1,
              ngay_phat_hanh: "2024-12-04",
              dau_bao: "Vietnam Biz",
              cum_noi_dung: "Ho·∫°t ƒë·ªông doanh nghi·ªáp v√† th√¥ng tin s·∫£n ph·∫©m",
              tom_tat_noi_dung:
                "T∆∞·ªùng An d·∫´n ƒë·∫ßu th·ªã tr∆∞·ªùng th·ª±c ph·∫©m m√πa T·∫øt 2025",
              link_bai_bao: "https://vietnambiz.vn/sample-article",
              nganh_hang: "D·∫ßu ƒÉn",
              nhan_hang: ["T∆∞·ªùng An"],
              keywords_found: ["T∆∞·ªùng An", "d·∫ßu ƒÉn", "T·∫øt 2025"],
            },
          ],
          total_articles: 1,
        };

        currentReport = sampleData;
        currentArticles = sampleData.articles;
        filteredArticles = [...currentArticles];

        updateSummaryTable();
        updateArticlesTable();
        updateCharts();
        updateDateRange();
      }

      function getActiveTask(tasks) {
        return (
          tasks.find((task) => task.session_id === currentSessionId) || null
        );
      }

      async function loadStatus() {
        try {
          // G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch task hi·ªán t·∫°i
          const response = await fetch("/api/tasks", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          const tasks = await response.json();

          //L·∫•y l·∫°i sessionId ƒë√£ l∆∞u t·ª´ localStorage (n·∫øu c√≥)
          const savedSessionId = localStorage.getItem("currentSessionId");

          let activeTask = null;

          if (savedSessionId) {
            // T√¨m task c√≥ session_id tr√πng kh·ªõp
            activeTask = tasks.find((t) => t.session_id === savedSessionId);
          }

          // N·∫øu kh√¥ng t√¨m th·∫•y (v√≠ d·ª• session ƒë√£ b·ªã x√≥a), fallback l·∫•y task m·ªõi nh·∫•t ƒëang ho·∫°t ƒë·ªông
          if (!activeTask && tasks.length > 0) {
            activeTask = getActiveTask(tasks); // H√†m ƒë√£ c√≥ s·∫µn c·ªßa b·∫°n
          }

          if (activeTask) {
            // G√°n l·∫°i sessionId sau F5 ƒë·ªÉ to√†n b·ªô h·ªá th·ªëng nh·ªõ ƒë√∫ng
            currentSessionId = activeTask.session_id;

            if (
              ["completed", "cancelled", "failed"].includes(activeTask.status)
            ) {
              localStorage.removeItem("currentSessionId");
            }
          }

          // G·ªçi h√†m c·∫≠p nh·∫≠t UI nh∆∞ c≈©
          updateTaskDisplay(activeTask, tasks);
          // N·∫øu ƒëang c√≥ task ·ªü tr·∫°ng th√°i pending ho·∫∑c running, m·ªü SSE ƒë·ªÉ nh·∫≠n c·∫≠p nh·∫≠t realtime
          if (activeTask && ["pending", "running"].includes(activeTask.status)) {
            // Ch·ªâ m·ªü SSE khi ch∆∞a c√≥ stream
            if (!tasksStreamController) {
              connectTasksSSE();
            }
          }
        } catch (error) {
          console.error("‚ùå Error loading task status:", error);
        }
      }

      function showCompletionModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("completionModal")
        );
        modal.show();
      }

      function updateTaskDisplay(activeTask, tasks) {
        // ---- Cache DOM ----
        const statusBadge = document.getElementById("statusBadge");
        const currentTaskEl = document.getElementById("currentTask");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progressText");
        const totalSourcesEl = document.getElementById("totalSources");
        const completedSourcesEl = document.getElementById("completedSources");
        const failedSourcesEl = document.getElementById("failedSources");

        const runBtn = document.getElementById("runBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const pauseResumeBtn = document.getElementById("pauseResumeBtn");
        const configBtn = document.getElementById("configBtn");

        if (
          !statusBadge ||
          !currentTaskEl ||
          !progressBar ||
          !progressText ||
          !runBtn
        )
          return;

        // ƒê·∫£m b·∫£o lu√¥n c√≥ th·∫ª <i> trong n√∫t Run ƒë·ªÉ ƒë·ªïi icon an to√†n
        let runIcon = runBtn.querySelector("i");
        if (!runIcon) {
          runIcon = document.createElement("i");
          runIcon.className = "fas fa-play me-2";
          runBtn.prepend(runIcon);
        }

        // ---- Normalize d·ªØ li·ªáu ----
        const t = activeTask ?? {};
        const status = t.status ?? "idle";
        const clamp = (n) =>
          Math.max(0, Math.min(100, Number.isFinite(+n) ? +n : 0));
        const prog = clamp(t.progress);

        // ---- Counters & progress ----
        const fallbackTotal = currentConfig?.selected_sources?.length
          ?? currentConfig?.media_sources?.length
          ?? 0;
        totalSourcesEl.textContent = t.total_sources ?? fallbackTotal;
        completedSourcesEl.textContent = t.completed_sources ?? 0;
        failedSourcesEl.textContent = t.failed_sources ?? 0;

        const targetProgress = Math.max(0, Math.min(100, prog));

        if (targetProgress > displayedProgress) {
          const step = () => {
            displayedProgress += 0.5; // t·ªëc ƒë·ªô tƒÉng (0.2‚Äì1)
            if (displayedProgress >= targetProgress) {
              displayedProgress = targetProgress;
            } else {
              requestAnimationFrame(step);
            }
            progressBar.style.width = displayedProgress.toFixed(1) + "%";
            progressText.textContent = Math.round(displayedProgress) + "%";
          };
          requestAnimationFrame(step);
        } else {
          displayedProgress = targetProgress;
          progressBar.style.width = `${targetProgress}%`;
          progressText.textContent = `${Math.round(targetProgress)}%`;
        }

        // ---- Helpers ----
        const setBadge = (cls, html) => {
          statusBadge.className = `status-badge ${cls}`;
          statusBadge.innerHTML = html;
        };
        const setButtons = ({
          runDisabled,
          cancelDisabled,
          pauseDisabled,
          configDisabled,
        }) => {
          runBtn.disabled = !!runDisabled;
          cancelBtn.disabled = !!cancelDisabled;
          pauseResumeBtn.disabled = !!pauseDisabled;
          configBtn.disabled = !!configDisabled;
        };
        const setPauseBtn = (isPausedView) => {
          if (isPausedView) {
            pauseResumeBtn.innerHTML = '<i class="fas fa-play me-2"></i>Resume';
            pauseResumeBtn.classList.remove("btn-outline-warning");
            pauseResumeBtn.classList.add("btn-outline-success");
          } else {
            pauseResumeBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
            pauseResumeBtn.classList.remove("btn-outline-success");
            pauseResumeBtn.classList.add("btn-outline-warning");
          }
        };

        // ---- UI theo tr·∫°ng th√°i ----
        switch (status) {
          case "pending": {
            setBadge(
              "status-pending",
              '<i class="fas fa-clock me-1"></i>Ready'
            );
            currentTaskEl.textContent =
              t.current_task || "Kh·ªüi t·∫°o pipeline...";
            runIcon.className = "fas fa-play me-2";
            setButtons({
              runDisabled: true,
              cancelDisabled: true,
              pauseDisabled: true,
              configDisabled: true,
            });
            setPauseBtn(false);
            break;
          }

          case "running": {
            setBadge(
              "status-running",
              '<i class="fas fa-spinner fa-spin me-1"></i>Running'
            );
            currentTaskEl.textContent = t.current_task || "ƒêang x·ª≠ l√Ω...";
            runIcon.className = "fas fa-spinner fa-spin me-2";
            setButtons({
              runDisabled: true,
              cancelDisabled: false,
              pauseDisabled: false,
              configDisabled: true,
            });
            setPauseBtn(false);
            break;
          }

          case "paused": {
            setBadge(
              "status-paused",
              '<i class="fas fa-pause-circle me-1"></i>Paused'
            );
            currentTaskEl.textContent = "Pause, press Resume to continue.";
            // Gi·ªØ icon run v·ªÅ m·∫∑c ƒë·ªãnh (kh√¥ng quay)
            runIcon.className = "fas fa-play me-2";
            // Kh√¥ng s·ª≠a innerHTML c·ªßa runBtn, ch·ªâ ƒë·ªïi icon tr√™n runIcon
            setButtons({
              runDisabled: true,
              cancelDisabled: false,
              pauseDisabled: false,
              configDisabled: true,
            });
            setPauseBtn(true);
            break;
          }

          case "cancelled": {
            setBadge(
              "status-stopping animate__animated animate__flash",
              '<i class="fas fa-times-circle me-1"></i>Cancelled'
            );
            currentTaskEl.textContent = "Cancelling by user";
            // Reset progress hi·ªÉn th·ªã
            progressBar.style.width = "0%";
            progressText.textContent = "0%";

            // Kh√≥a n√∫t trong l√∫c backend ƒëang finalize
            setButtons({
              runDisabled: true,
              cancelDisabled: true,
              pauseDisabled: true,
              configDisabled: true,
            });
            runIcon.className = "fas fa-play me-2";

            // Khi backend b√°o xong, m·ªü l·∫°i
            if (
              t.current_task === "Pipeline was cancelled" ||
              t.current_task === "Restarting system"
            ) {
              currentTaskEl.textContent = "Cancelled by user";
              setButtons({
                runDisabled: false,
                cancelDisabled: true,
                pauseDisabled: true,
                configDisabled: false,
              });
              if (typeof currentSessionId !== "undefined")
                currentSessionId = null;
            }
            break;
          }

          case "completed": {
            setBadge(
              "status-completed",
              '<i class="fas fa-check-circle me-1"></i>Completed'
            );
            currentTaskEl.textContent = "All set! Waiting for your next run.";
            progressBar.style.width = "100%";
            progressText.textContent = "100%";
            runIcon.className = "fas fa-play me-2";
            setButtons({
              runDisabled: false,
              cancelDisabled: true,
              pauseDisabled: true,
              configDisabled: false,
            });

            if (typeof showCompletionModal === "function")
              showCompletionModal();
            if (typeof currentSessionId !== "undefined")
              currentSessionId = null;
            break;
          }

          case "failed": {
            setBadge(
              "status-failed animate__animated animate__shakeX",
              '<i class="fas fa-exclamation-triangle me-1"></i>Failed'
            );
            currentTaskEl.textContent = "An error occurred, please run again.";
            runIcon.className = "fas fa-play me-2";
            setButtons({
              runDisabled: false,
              cancelDisabled: true,
              pauseDisabled: true,
              configDisabled: false,
            });
            break;
          }

          case "idle":
          default: {
            setBadge(
              "status-idle",
              '<i class="fas fa-circle-notch me-1"></i>Idle'
            );
            currentTaskEl.textContent = "S·∫µn s√†ng ch·∫°y pipeline";
            progressBar.style.width = "0%";
            progressText.textContent = "0%";

            // T·ªïng ngu·ªìn l·∫•y t·ª´ config hi·ªán t·∫°i n·∫øu backend ch∆∞a c√≥
            totalSourcesEl.textContent =
              currentConfig?.selected_sources?.length ?? 0;
            completedSourcesEl.textContent = 0;
            failedSourcesEl.textContent = 0;

            runIcon.className = "fas fa-play me-2";
            setButtons({
              runDisabled: false,
              cancelDisabled: true,
              pauseDisabled: true,
              configDisabled: false,
            });
            break;
          }
        }
      }

      function openSettings() {
        loadSettings();
        new bootstrap.Modal(document.getElementById("settingsModal")).show();
      }

      function loadKeywordConfiguration() {
        // Prefill dates
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        document.getElementById("startDate").value = ls.get(LS.START, thirtyDaysAgo.toISOString().split("T")[0]);
        document.getElementById("endDate").value = ls.get(LS.END, today.toISOString().split("T")[0]);

        // Prefill keywords from LS only
        renderKeywordInputsFrom(getSavedCustomKeywords());
      }

      function renderKeywordInputsFrom(kws) {
        const container = document.getElementById("keywordContainer");
        container.innerHTML = "";
        if (!kws) return; // ƒë·ªÉ tr·ªëng, user s·∫Ω Add Industry
        Object.entries(kws).forEach(([industry, arr]) => addIndustryWith(industry, arr));
      }

      function addIndustryWith(name, arr) {
        addIndustry(); // d√πng UI builder s·∫µn c√≥
        const block = document.querySelector("#keywordContainer .mb-3:last-child");
        block.querySelector(".industryName").value = name;
        block.querySelector(".industry-keywords").value = Array.isArray(arr) ? arr.join(", ") : "";
      }

      function getSavedSelectedSources() { return ls.getJSON(LS.SOURCES, []); }
      function getSavedDateRange() { return { start: ls.get(LS.START, null), end: ls.get(LS.END, null) }; }
      function getSavedCustomKeywords() { return ls.getJSON(LS.KW, null); }
      function hasSavedSettings() { return getSavedSelectedSources().length > 0; }
      function hasSavedKeywords() { const kw = getSavedCustomKeywords(); return kw && Object.keys(kw).length > 0; }
      async function resetKeywords() {
        ls.del(LS.KW);
        renderKeywordInputsFrom(null);
        addIndustry(); // g·ª£i √Ω √¥ tr·ªëng ƒë·∫ßu ti√™n
        addActivityLog("Keywords Reset", "ƒê√£ x√≥a keywords tr√™n m√°y. Nh·∫≠p l·∫°i ƒë·ªÉ ch·∫°y.");
      }

      let es;
      let handledSwitches = new Set();
      let decisionInFlight = false;
      let lastDecision = null; // nh·ªõ quy·∫øt ƒë·ªãnh ƒë·∫ßu ti√™n c·ªßa user

      // === Tasks SSE ===
      // Controller for the tasks Server-Sent Events (SSE) connection. When defined,
      // the associated AbortController can cancel the active fetch-based SSE stream.
      let tasksStreamController;

      function openEventStream(sessionId) {
        if (es) es.close();
        es = new EventSource(`/api/events/${encodeURIComponent(sessionId)}`);
        es.onmessage = async (ev) => {
          const evt = JSON.parse(ev.data);

          // G·ª£i √Ω chuy·ªÉn provider ‚Äî ch·ªâ khi H·∫æT QUOTA
          if (evt.type === "propose_switch") {
            // N·∫øu BE ch∆∞a g·ª≠i code (legacy), v·∫´n cho hi·ªán; c√≤n n·∫øu c√≥ code th√¨ filter ch·∫∑t
            if (evt.code && evt.code !== "PROVIDER_NO_QUOTA") return;

            // Dedupe theo provider+model+code (·ªïn ƒë·ªãnh h∆°n message)
            const key = `switch:${evt.from_provider}:${evt.from_model}:${evt.code || "unknown"}`;
            if (handledSwitches.has(key)) return;

            // Ch·ªâ auto-apply n·∫øu quy·∫øt ƒë·ªãnh tr∆∞·ªõc l√† SWITCH (kh√¥ng auto-abort)
            if (lastDecision && lastDecision.action === "switch") {
              handledSwitches.add(key);
              try {
                await fetch(
                  `/api/agents/${sessionId}/providers/${encodeURIComponent(evt.from_provider)}/cancel`,
                  { method: "POST", headers: { Authorization: `Bearer ${localStorage.getItem("token") || ""}` } }
                );
              } catch (e) { console.warn("cancel old provider failed:", e); }

              await fetch("/api/run/decision", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ session_id: sessionId, ...lastDecision })
              });
              return;
            }

            if (decisionInFlight) return;
            decisionInFlight = true;

            const next = evt.suggested || (evt.next_options && evt.next_options[0]);
            const ok = confirm(
              `Provider l·ªói: ${evt.from_provider} (${evt.from_model})\n${evt.message}\n\nChuy·ªÉn sang: ${next}?`
            );

            lastDecision = { action: ok ? "switch" : "abort", provider: ok ? next : null };
            handledSwitches.add(key);

            if (ok) {
              // H·ªßy provider c≈© tr∆∞·ªõc khi switch
              await fetch(`/api/agents/${sessionId}/providers/${encodeURIComponent(evt.from_provider)}/cancel`, {
                method: "POST",
                headers: { Authorization: `Bearer ${localStorage.getItem("token") || ""}` }
              });
            }

            await fetch("/api/run/decision", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ session_id: sessionId, ...lastDecision })
            }).finally(() => { decisionInFlight = false; });
          }

          // H·∫øt provider ‚Äì ch·ªâ b√°o 1 l·∫ßn
          if (evt.type === "provider_error" && evt.final) {
            if (!handledSwitches.has("final")) {
              handledSwitches.add("final");
              alert(`H·∫øt provider. L·ªói cu·ªëi: ${evt.message}`);
              closeEventStream();
            }
          }
        };
      }

      function closeEventStream() {
        if (es) {
          try {
            es.close(); // ƒê√≥ng k·∫øt n·ªëi SSE
          } catch (err) {
            console.error("L·ªói khi ƒë√≥ng EventSource:", err);
          }
          es = null;
        }
        console.log("üîå Event stream ƒë√£ ƒë√≥ng");
      }

      /**
       * Open an SSE connection to stream task status updates in real time. The SSE
       * endpoint requires the user's auth token, so we use fetch() with an
       * AbortController to read the event stream manually. When a task finishes
       * (completed/cancelled/failed), the connection is closed and the UI is
       * refreshed via loadStatus(). If the SSE connection fails for any reason,
       * the code falls back to the existing polling mechanism.
       */
      async function connectTasksSSE() {
        // Abort any existing tasks SSE stream
        if (tasksStreamController) {
          try {
            tasksStreamController.abort();
          } catch (_) { }
          tasksStreamController = null;
        }
        const controller = new AbortController();
        tasksStreamController = controller;
        try {
          const token = localStorage.getItem("token") || "";
          const response = await fetch("/api/tasks/events", {
            headers: { Authorization: `Bearer ${token}` },
            signal: controller.signal,
          });
          if (!response.ok) {
            console.warn("SSE /api/tasks/events failed, falling back to polling");
            startIntensivePollingFallback();
            return;
          }
          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let buffer = "";
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            let parts = buffer.split("\n\n");
            for (let i = 0; i < parts.length - 1; i++) {
              const segment = parts[i].trim();
              if (!segment) continue;
              // Support multi-line SSE events
              const lines = segment.split("\n");
              let dataStr = "";
              lines.forEach((l) => {
                const idx = l.indexOf(":");
                if (idx >= 0) {
                  const field = l.slice(0, idx).trim();
                  const valuePart = l.slice(idx + 1).trim();
                  if (field === "data") {
                    // Append the value; SSE may send multiple data: lines
                    dataStr += valuePart;
                  }
                }
              });
              if (dataStr) {
                try {
                  const tasks = JSON.parse(dataStr);
                  const currentTask = currentSessionId
                    ? tasks.find((t) => t.session_id === currentSessionId)
                    : null;
                  if (currentTask) {
                    updateTaskDisplay(currentTask, tasks);
                    // When task finishes: completed/cancelled/failed
                    if (["completed", "cancelled", "failed"].includes(currentTask.status)) {
                      // If completed, load the report
                      if (currentTask.status === "completed") {
                        await loadLatestReport();
                      }
                      closeEventStream();
                      closeTasksSSE();
                      addActivityLog(
                        "Task Finished",
                        `Session ${currentSessionId} has status: ${currentTask.status}`
                      );
                      await loadStatus();
                      return;
                    }
                  }
                } catch (err) {
                  console.error("Error parsing SSE tasks event:", err);
                }
              }
            }
            buffer = parts[parts.length - 1];
          }
        } catch (err) {
          if (err.name !== "AbortError") {
            console.error("SSE tasks connection error:", err);
            // fallback to polling only if error is not due to abort
            startIntensivePollingFallback();
          }
        }
      }

      /**
       * Abort the tasks SSE stream if it exists. After calling this, you can
       * safely start another tasks SSE connection.
       */
      function closeTasksSSE() {
        if (tasksStreamController) {
          try {
            tasksStreamController.abort();
          } catch (_) { }
          tasksStreamController = null;
        }
      }

      /**
       * Fallback polling implementation for intensive updates. If SSE fails or
       * isn't supported, this function sets up a 3-second interval to fetch
       * /api/tasks and update the UI. When the task completes, it cleans up
       * and reloads the status.
       */
      function startIntensivePollingFallback() {
        if (!currentSessionId) return;
        if (pollingInterval) {
          clearInterval(pollingInterval);
        }
        pollingInterval = setInterval(async () => {
          try {
            const response = await fetch("/api/tasks", {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            });
            const tasks = await response.json();
            const currentTask = tasks.find((t) => t.session_id === currentSessionId);
            if (currentTask) {
              updateTaskDisplay(currentTask, tasks);
              if (["completed"].includes(currentTask.status)) {
                await loadLatestReport();
              }
              if (["completed", "cancelled", "failed"].includes(currentTask.status)) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                closeEventStream();
                addActivityLog(
                  "Task Finished",
                  `Session ${currentSessionId} has status: ${currentTask.status}`
                );
                await loadStatus();
              }
            } else {
              console.warn("Task not found in fallback polling.");
            }
          } catch (err) {
            console.error("Polling error:", err);
          }
        }, 3000);
      }

      // Event handlers
      async function runPipeline() {
        const session_id = generateSessionId();
        currentSessionId = session_id;
        openEventStream(session_id);
        localStorage.setItem("currentSessionId", session_id);

        // Guard 1: ph·∫£i c√≥ ngu·ªìn
        const selectedSources = getSavedSelectedSources();
        if (!selectedSources.length) {
          addActivityLog("C·∫ßn c·∫•u h√¨nh", "B·∫°n ch∆∞a ch·ªçn ngu·ªìn.", "warning");
          showAlert?.("warning", "C·∫ßn c·∫•u h√¨nh", "Ch·ªçn √≠t nh·∫•t 1 ngu·ªìn r·ªìi Save/Run.");
          await showConfigModal();
          return;
        }

        // Guard 2: ph·∫£i c√≥ keywords (ch·ªâ l·∫•y t·ª´ LS)
        if (!hasSavedKeywords()) {
          addActivityLog("C·∫ßn c·∫•u h√¨nh", "B·∫°n ch∆∞a nh·∫≠p keywords.", "warning");
          showAlert?.("warning", "C·∫ßn c·∫•u h√¨nh", "Nh·∫≠p keywords cho t·ª´ng ng√†nh r·ªìi Save/Run.");
          await showConfigModal();
          return;
        }

        // Guard 3: kh√¥ng ƒë∆∞·ª£c c√≥ task ƒëang ch·∫°y
        // try {
        //   const check = await fetch("/api/tasks", {
        //     headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
        //   });
        //   const tasks = await check.json();
        //   if (tasks.some(t => ["running", "pending"].includes(t.status))) {
        //     addActivityLog("Warning", "A task is already running. Please wait...", "warning");
        //     return;
        //   }
        // } catch (error) {
        //   console.error("Error checking tasks:", error);
        // }

        try {
          const response = await fetch("/api/run", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`
            },
            body: JSON.stringify({
              session_id,
              start_date: getSavedDateRange().start,
              end_date: getSavedDateRange().end,
              custom_keywords: getSavedCustomKeywords(),
              selected_sources: selectedSources
            }),
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.detail || "Failed to start pipeline");

          addActivityLog("Pipeline Started", "Qu√° tr√¨nh crawling ƒë√£ b·∫Øt ƒë·∫ßu");
          document.getElementById("runBtn").disabled = true;
          document.getElementById("cancelBtn").disabled = false;
          document.getElementById("configBtn").disabled = true;
          document.getElementById("totalSources").textContent = selectedSources.length;

          // Start streaming task updates via SSE instead of polling
          connectTasksSSE();
        } catch (error) {
          console.error(error);
          addActivityLog("Error", "L·ªói khi kh·ªüi ƒë·ªông pipeline: " + error.message, "error");
          showAlert?.("danger", "L·ªói!", error.message);
        }
      }

      async function cancelPipeline() {
        if (!currentSessionId) return;

        try {
          await fetch(`/api/tasks/${currentSessionId}/cancel`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          addActivityLog("Pipeline cancelled");
          if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
          }
          // Close the SSE stream for tasks when cancelling a pipeline
          closeTasksSSE();
          loadStatus();
        } catch (err) {
          console.error(err);
        }
      }

      function updateSummaryTable() {
        const tbody = document.getElementById("summaryTableBody");

        if (!currentReport || !currentReport.overall_summary) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }

        const industries = currentReport.overall_summary.industries || [];

        if (industries.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ng√†nh h√†ng</td></tr>';
          return;
        }

        tbody.innerHTML = industries
          .map(
            (industry) => `
                <tr class="fade-in">
                    <td><strong>${industry.nganh_hang}</strong></td>
                    <td>
                        ${industry.nhan_hang
                .map(
                  (brand) =>
                    `<span class="industry-pill">${brand}</span>`
                )
                .join("")}
                    </td>
                    <td>
                        <small class="text-muted">${industry.cac_dau_bao
                .slice(0, 3)
                .join(", ")}${industry.cac_dau_bao.length > 3 ? "..." : ""
              }</small>
                    </td>
                    <td>
                        <span class="badge bg-primary">${industry.so_luong_bai
              }</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="filterByIndustry('${industry.nganh_hang
              }')">
                            <i class="fas fa-filter me-1"></i>Xem
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");

        // Update industry filter dropdown
        const industryFilter = document.getElementById("industryFilter");
        industryFilter.innerHTML =
          '<option value="">T·∫•t c·∫£ ng√†nh</option>' +
          industries
            .map(
              (industry) =>
                `<option value="${industry.nganh_hang}">${industry.nganh_hang}</option>`
            )
            .join("");
      }

      function updateSTT() {
        const rows = document.querySelectorAll("#articlesTableBody tr");
        rows.forEach((row, idx) => {
          const sttCell = row.querySelector(".stt-cell");
          if (sttCell) {
            sttCell.innerHTML = `<strong>${idx + 1}</strong>`;
          }
        });
      }

      function updateArticlesTable() {
        const tbody = document.getElementById("articlesTableBody");

        if (!filteredArticles || filteredArticles.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ b√†i b√°o</td></tr>';
          updatePagination(0);
          return;
        }

        // Pagination
        const startIndex = (currentPage - 1) * articlesPerPage;
        const endIndex = startIndex + articlesPerPage;
        const pageArticles = filteredArticles.slice(startIndex, endIndex);

        tbody.innerHTML = pageArticles
          .map(
            (article) => `
                <tr class="fade-in">
                    <td class="stt-cell"></td>
                    <td>${formatDate(article.ngay_phat_hanh)}</td>
                    <td><strong>${article.dau_bao}</strong></td>
                    <td><small class="text-muted">${article.cum_noi_dung
              }</small></td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${article.tom_tat_noi_dung.replace(
                /"/g,
                "&quot;"
              )}">
                        ${document
                .createElement("div")
                .appendChild(
                  document.createTextNode(article.tom_tat_noi_dung)
                ).parentNode.innerHTML
              }
                        </div>
                    </td>
                    <td><span class="industry-pill">${article.nganh_hang
              }</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showArticleDetail(${article.stt
              })">
                            <i class="fas fa-eye me-1"></i>Xem
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
        updateSTT();
        updatePagination(filteredArticles.length);
      }

      function updatePagination(totalItems) {
        const pagination = document.getElementById("pagination");
        const totalPages = Math.ceil(totalItems / articlesPerPage);

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        let paginationHTML = "";

        // Previous button
        paginationHTML += `
                <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1
          })" ${currentPage === 1 ? 'tabindex="-1"' : ""}>
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (
            i === currentPage ||
            i === 1 ||
            i === totalPages ||
            (i >= currentPage - 2 && i <= currentPage + 2)
          ) {
            paginationHTML += `
                        <li class="page-item ${i === currentPage ? "active" : ""
              }">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHTML +=
              '<li class="page-item disabled"><span class="page-link">...</span></li>';
          }
        }

        // Next button
        paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? "disabled" : ""
          }">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1
          })" ${currentPage === totalPages ? 'tabindex="-1"' : ""}>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

        pagination.innerHTML = paginationHTML;
      }

      function updateCharts() {
        updateIndustryChart();
        updateMediaChart();
      }

      // ----- Color palette helper (10 m√†u an to√†n + fallback) -----
      function palette(i) {
        const base = [
          "#4e79a7", "#f28e2b", "#e15759", "#76b7b2", "#59a14f",
          "#edc948", "#b07aa1", "#ff9da7", "#9c755f", "#bab0ab"
        ];
        if (i < base.length) return base[i];
        // Fallback khi >10 nh√£n: quay v√≤ng theo "golden angle"
        const hue = (i * 137.508) % 360;
        return `hsl(${Math.round(hue)} 60% 55%)`;
      }

      function updateIndustryChart() {
        const ctx = document.getElementById("industryChart").getContext("2d");

        if (industryChart) {
          industryChart.destroy();
        }

        if (
          !currentReport ||
          !currentReport.overall_summary ||
          !currentReport.overall_summary.industries
        ) {
          return;
        }

        const industries = currentReport.overall_summary.industries;
        const labels = industries.map(industry => industry.nganh_hang);
        const data = industries.map(industry => industry.so_luong_bai);
        const colors = labels.map((_, i) => palette(i));

        industryChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderWidth: 2,
              borderColor: "#fff",
              hoverBackgroundColor: "#e74c3c"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  color: "#000",
                  font: { size: 13 }
                }
              },
              title: {
                display: true,
                text: "Ph√¢n B·ªë B√†i B√°o Theo Ng√†nh H√†ng",
                color: "#000",
                font: { size: 16, weight: "bold" }
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.label || '';
                    let value = context.formattedValue || 0;
                    return `${label}: ${value} b√†i`;
                  },
                  title: function () {
                    return ''; // Kh√¥ng hi·ªÉn th·ªã title m·∫∑c ƒë·ªãnh
                  }
                }
              }
            }
          }
        });
      }

      function updateMediaChart() {
        const ctx = document.getElementById("mediaChart").getContext("2d");

        if (mediaChart) {
          mediaChart.destroy();
        }

        if (!currentArticles || currentArticles.length === 0) {
          return;
        }

        // ƒê·∫øm s·ªë b√†i theo b√°o + ng√†nh
        const mediaCounts = {};
        currentArticles.forEach(article => {
          const label = `${article.dau_bao} (${article.nganh_hang || 'N/A'})`;
          mediaCounts[label] = (mediaCounts[label] || 0) + 1;
        });

        // Top 10
        const sortedMedia = Object.entries(mediaCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        const labels = sortedMedia.map(item => item[0]);
        const data = sortedMedia.map(item => item[1]);
        const colors = labels.map((_, i) => palette(i));

        mediaChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "S·ªë b√†i b√°o",
              data: data,
              backgroundColor: colors,
              borderColor: labels.map(() => "#333"),
              borderWidth: 1,
              hoverBackgroundColor: "#e74c3c"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                // text: "Top 10 Ngu·ªìn Tin & Ng√†nh H√†ng",
                color: "#222", // m√†u ƒë·ªìng b·ªô theme s√°ng
                font: { size: 16, weight: "bold" },
                padding: { top: 0, bottom: 15 }
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.label}: ${context.formattedValue} b√†i`;
                  },
                  title: function () {
                    return ''; // Kh√¥ng hi·ªÉn th·ªã title m·∫∑c ƒë·ªãnh
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: "#444",
                  precision: 0,
                  font: { size: 13 }
                },
                grid: { color: "#e0e0e0" },
                title: {
                  display: true,
                  text: "S·ªë l∆∞·ª£ng b√†i b√°o",
                  color: "#222",
                  font: { size: 15, weight: "bold" },
                  padding: { top: 0, bottom: 10 }
                }
              },
              x: {
                ticks: {
                  color: "#444",
                  maxRotation: 45, // ‚úÖ gi·ªØ g√≥c 45¬∞ cho d·ªÖ ƒë·ªçc
                  minRotation: 45,
                  font: { size: 10 },
                  callback: function (value) {
                    let label = this.getLabelForValue(value);
                    return label.length > 20 ? label.slice(0, 20) + '‚Ä¶' : label;
                  }
                },
                grid: { display: false },
                title: {
                  display: true,
                  text: "Ngu·ªìn tin & Ng√†nh h√†ng",
                  color: "#222",
                  font: { size: 15, weight: "bold" },
                  padding: { top: 10 },
                }
              }
            }
          }
        });
      }

      function updateDateRange() {
        const dateRangeElement = document.getElementById("dateRange");
        if (currentReport && currentReport.overall_summary) {
          const rawDate = currentReport.date_range;

          // V√≠ d·ª• rawDate: "T·ª´ ng√†y 01/07/2025 ƒë·∫øn ng√†y 25/07/2025"
          const match = rawDate.match(/T·ª´ ng√†y (.+?) ƒë·∫øn ng√†y (.+)/);
          if (match) {
            const start = match[1];
            const end = match[2];
            dateRangeElement.textContent = `${start} ‚Üí ${end}`;
          } else {
            dateRangeElement.textContent = rawDate;
          }
        }
      }

      function showConfigModal() {
        showModal("configModal");

        const body = document.querySelector('#configModal .modal-body');
        const footer = document.querySelector('#configModal .modal-footer');

        Promise.all([
          loadCurrentConfig(),
          loadKeywordConfiguration(),
          loadPipelineMediaPicker()
        ])
          .then(() => {
            const container = document.getElementById("keywordContainer");
            if (!container.querySelector(".industryName")) addIndustry();
          })
          .catch(err => console.error(err))
      }

      function renderKeywordInputs(industries) {
        const container = document.getElementById("keywordContainer");
        container.innerHTML = "";
        if (!industries) return;

        Object.entries(industries).forEach(([industry, kws]) => {
          addIndustryWith(industry, kws);
        });
      }

      function setDateRange(range) {
        const today = new Date();
        let startDate = new Date();

        switch (range) {
          case "today":
            startDate = new Date(today);
            break;
          case "week":
            startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
          case "month":
            startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            break;
          case "quarter":
            startDate = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
            break;
        }

        document.getElementById("startDate").value = startDate
          .toISOString()
          .split("T")[0];
        document.getElementById("endDate").value = today
          .toISOString()
          .split("T")[0];
      }

      function addIndustry() {
        const container = document.getElementById("keywordContainer");
        const div = document.createElement("div");
        div.className = "mb-3 border rounded p-3";
        div.innerHTML = `
          <div class="d-flex align-items-center mb-2">
            <select class="form-select form-select-sm industryName me-2 flex-grow-1" required>
              <option value="">-- Ch·ªçn ng√†nh h√†ng --</option>
              <option value="D·∫ßu ƒÉn">D·∫ßu ƒÉn</option>
              <option value="Gia v·ªã">Gia v·ªã</option>
              <option value="G·∫°o & Ng≈© c·ªëc">G·∫°o & Ng≈© c·ªëc</option>
              <option value="S·ªØa (UHT)">S·ªØa (UHT)</option>
              <option value="Homecare">Homecare</option>
            </select>
            <button type="button"
                    class="btn btn-outline-danger p-0"
                    style="width:50px; height:28px; border-width:1px; border-radius:6px;"
                    onclick="removeIndustry(this)">
              <i class="fas fa-trash fa-sm"></i>
            </button>
          </div>

        <textarea class="form-control form-control-sm industry-keywords" rows="2" placeholder="Keywords separated by commas"></textarea>
      `;
        container.appendChild(div);
      }


      function removeIndustry(button) {
        button.closest(".mb-3").remove();
      }

      function collectKeywordConfiguration() {
        const start_date = document.getElementById("startDate").value || null;
        const end_date = document.getElementById("endDate").value || null;

        const customKeywords = {};
        document.querySelectorAll("#keywordContainer .mb-3").forEach(block => {
          const nameEl = block.querySelector(".industryName");
          const kwEl = block.querySelector(".industry-keywords");
          if (!nameEl || !kwEl) return;
          const name = nameEl.value.trim();
          const kws = kwEl.value.split(",").map(s => s.trim()).filter(Boolean);
          if (name && kws.length) customKeywords[name] = kws;
        });

        return {
          start_date,
          end_date,
          custom_keywords: Object.keys(customKeywords).length ? customKeywords : null,
        };
      }

      function formatDateLocal(date) {
        const year = date.getFullYear();
        const month = `${date.getMonth() + 1}`.padStart(2, "0");
        const day = `${date.getDate()}`.padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      async function saveConfigInModal() {
        try {
          const cfg = collectKeywordConfiguration(); // {start_date, end_date, custom_keywords}

          // L∆∞u LS
          const selectedSources = Array.from(PIPELINE_SELECTED_MEDIA);
          ls.setJSON(LS.SOURCES, selectedSources);
          if (cfg.start_date) ls.set(LS.START, cfg.start_date);
          if (cfg.end_date) ls.set(LS.END, cfg.end_date);
          if (cfg.custom_keywords) ls.setJSON(LS.KW, cfg.custom_keywords); else ls.del(LS.KW);
          ls.set(LS.UPDATED, new Date().toISOString());

          // 1) L∆∞u keywords v√†o BE (ƒë√¢y m·ªõi l√† c√°i ghi keywords.json)
          if (cfg.custom_keywords) {
            const kwRes = await fetch("/api/keywords", {
              method: "POST",
              headers: { "Content-Type": "application/json", Authorization: `Bearer ${localStorage.getItem("token")}` },
              body: JSON.stringify(cfg.custom_keywords),
            });
            if (!kwRes.ok) {
              const err = await kwRes.text();
              throw new Error("L∆∞u keywords th·∫•t b·∫°i: " + err);
            }
          }

          // 2) (Tu·ª≥ ch·ªçn) Sync c√°c tham s·ªë kh√°c v√†o /api/config n·∫øu c·∫ßn
          const cfgRes = await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${localStorage.getItem("token")}` },
            body: JSON.stringify({
              selected_sources: selectedSources,
              // ƒë·ª´ng g·ª≠i custom_keywords/start_date/end_date v√†o /api/config n·ªØa
            }),
          });
          if (!cfgRes.ok) {
            const err = await cfgRes.text();
            throw new Error("L∆∞u config th·∫•t b·∫°i: " + err);
          }

          addActivityLog("Config Saved", "ƒê√£ l∆∞u c·∫•u h√¨nh v√† keywords v√†o BE.");
          showAlert?.("success", "ƒê√£ l∆∞u", "C·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c l∆∞u.");
          bootstrap.Modal.getInstance(document.getElementById('configModal'))?.hide();
        } catch (err) {
          console.error("saveConfigInModal error:", err);
          addActivityLog("Error", String(err.message || err), "error");
          showAlert?.("danger", "L·ªói", String(err.message || err));
        }
      }

      async function runWithConfig() {
        try {
          const cfg = collectKeywordConfiguration();

          // Validate date (<= 180 ng√†y)
          if (cfg.start_date && cfg.end_date) {
            const start = new Date(cfg.start_date), end = new Date(cfg.end_date);
            const diffDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24));
            if (start > end) return showAlert("warning", "Invalid Date Range", "Start date must be before end date");
            if (diffDays > 180) return showAlert("warning", "Date Range Too Long", "Select a date range ‚â§ 180 days");
          }

          // Persist to LS
          const effectiveSelected = Array.from(PIPELINE_SELECTED_MEDIA);
          if (!effectiveSelected.length) { await showConfigModal(); return showAlert("warning", "C·∫ßn c·∫•u h√¨nh", "Ch·ªçn √≠t nh·∫•t 1 ngu·ªìn."); }

          ls.setJSON(LS.SOURCES, effectiveSelected);
          if (cfg.start_date) ls.set(LS.START, cfg.start_date);
          if (cfg.end_date) ls.set(LS.END, cfg.end_date);
          if (cfg.custom_keywords) ls.setJSON(LS.KW, cfg.custom_keywords); else ls.del(LS.KW);
          ls.set(LS.UPDATED, new Date().toISOString());

          // (T√πy ch·ªçn) sync BE ph·∫ßn sources/dates
          fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${localStorage.getItem("token")}` },
            body: JSON.stringify({ selected_sources: effectiveSelected, start_date: cfg.start_date, end_date: cfg.end_date }),
          }).catch(() => { });

          // Run (l·∫•y keywords t·ª´ LS)
          const session_id = generateSessionId();
          currentSessionId = session_id;
          openEventStream(session_id);
          document.getElementById("totalSources").textContent = effectiveSelected.length;

          const response = await fetch("/api/run", {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${localStorage.getItem("token")}` },
            body: JSON.stringify({
              session_id: session_id,
              start_date: ls.get(LS.START, null),
              end_date: ls.get(LS.END, null),
              custom_keywords: getSavedCustomKeywords(),
              selected_sources: effectiveSelected
            }),
          });
          const result = await response.json();
          if (!response.ok) throw new Error(result.detail || "Failed to start pipeline");

          addActivityLog("Pipeline Started", `Session: ${session_id}`);
          document.getElementById("runBtn").disabled = true;
          document.getElementById("cancelBtn").disabled = false;
          document.getElementById("configBtn").disabled = true;

          bootstrap.Modal.getInstance(document.getElementById("configModal"))?.hide();
          // Start streaming task updates via SSE instead of polling
          connectTasksSSE();
        } catch (error) {
          console.error(error);
          addActivityLog("Error", String(error.message || error), "error");
          showAlert?.("danger", "L·ªói!", String(error.message || error));
        }
      }

      function filterArticles() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const industryFilter = document.getElementById("industryFilter").value;

        filteredArticles = currentArticles.filter((article) => {
          const brands = Array.isArray(article.nhan_hang) ? article.nhan_hang : [];
          const matchesSearch =
            !searchTerm ||
            article.tom_tat_noi_dung.toLowerCase().includes(searchTerm) ||
            article.dau_bao.toLowerCase().includes(searchTerm) ||
            brands.some(b => b.toLowerCase().includes(searchTerm));
          const matchesIndustry =
            !industryFilter || article.nganh_hang === industryFilter;

          return matchesSearch && matchesIndustry;
        });

        currentPage = 1;
        updateArticlesTable();
      }

      function filterByIndustry(industry) {
        document.getElementById("industryFilter").value = industry;
        filterArticles();

        // Scroll to articles section
        document
          .querySelector("#articlesTableBody")
          .scrollIntoView({ behavior: "smooth" });
      }

      function changePage(page) {
        const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);

        if (page >= 1 && page <= totalPages) {
          currentPage = page;
          updateArticlesTable();

          // Scroll to top of table
          document
            .querySelector("#articlesTableBody")
            .scrollIntoView({ behavior: "smooth" });
        }
      }

      function showArticleDetail(stt) {
        const article = currentArticles.find((a) => a.stt === stt);
        if (!article) return;

        const content = document.getElementById("articleContent");
        content.innerHTML = `
                <div class="row">
                    <div class="col-12 col-md-6">
                        <p><strong>STT:</strong> ${article.stt}</p>
                        <p><strong>Ng√†y ph√°t h√†nh:</strong> ${formatDate(article.ngay_phat_hanh)}</p>
                        <p><strong>ƒê·∫ßu b√°o:</strong> ${article.dau_bao}</p>
                        <p><strong>Ng√†nh h√†ng:</strong> <span class="industry-pill">${article.nganh_hang}</span></p>
                    </div>
                    <div class="col-12 col-md-6">
                        <p><strong>C·ª•m n·ªôi dung:</strong> ${article.cum_noi_dung}</p>
                        <p><strong>Nh√£n h√†ng:</strong> ${article.nhan_hang
            .map(
              (brand) =>
                `<span class="industry-pill">${brand}</span>`
            )
            .join(" ")}</p>
                        <p><strong>Keywords:</strong> ${(
            article.keywords_found || []
          ).join(", ")}</p>
                    </div>
                </div>
                <hr>
                <div>
                    <h6>T√≥m t·∫Øt n·ªôi dung:</h6>
                    <p>${article.tom_tat_noi_dung}</p>
                </div>
            `;

        document.getElementById("articleLink").href = article.link_bai_bao;

        new bootstrap.Modal(document.getElementById("articleModal")).show();
      }

      async function downloadReport(format) {
        try {
          const response = await fetch(
            `/api/reports/download/latest?format=${format}`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `competitor_report.${format === "excel" ? "xlsx" : "json"
              }`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addActivityLog(
              "Download",
              `ƒê√£ t·∫£i xu·ªëng b√°o c√°o ƒë·ªãnh d·∫°ng ${format.toUpperCase()}`
            );
          } else {
            throw new Error("Failed to download report");
          }
        } catch (error) {
          console.error("Error downloading report:", error);
          addActivityLog("Error", "L·ªói khi t·∫£i xu·ªëng b√°o c√°o", "error");
        }
      }

      const MODEL_CATALOG = {
        openai: ["gpt-4o-mini", "gpt-4o", "o4-mini", "o3-mini"],
        groq: ["llama-3.1-70b-versatile", "llama-3.1-8b-instant"],
        gemini: ["gemini-2.0-flash", "gemini-1.5-flash"],
      };

      function fillModelsFor(provider, preselect) {
        const sel = document.getElementById("defaultModel");
        sel.innerHTML = "";
        (MODEL_CATALOG[provider] || []).forEach((m) => {
          const opt = document.createElement("option");
          opt.value = m;
          opt.textContent = m;
          sel.appendChild(opt);
        });
        if (preselect && [...sel.options].some((o) => o.value === preselect)) {
          sel.value = preselect;
        }
      }
      // FIXED: Load settings v·ªõi proper field mapping
      async function loadSettings() {
        if (isLoadSettings) return;
        isLoadSettings = true
        try {
          // 1) Load API keys status
          const apiRes = await fetch("/api/api-keys/status", {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
          });
          if (!apiRes.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c API key status");
          const apiStatus = await apiRes.json();

          // 2) C·∫≠p nh·∫≠t ƒë√®n tr·∫°ng th√°i key
          updateApiKeyStatus("openai", apiStatus.openai_configured);
          updateApiKeyStatus("groq", apiStatus.groq_configured);
          updateApiKeyStatus("google", apiStatus.google_configured);

          // 3) L·ªçc dropdown Provider ch·ªâ gi·ªØ provider ƒë√£ c·∫•u h√¨nh
          const providerSel = document.getElementById("defaultProvider");
          const modelSel = document.getElementById("defaultModel");
          providerSel.innerHTML = "";

          const providers = [];
          if (apiStatus.openai_configured) {
            providers.push({ value: "openai", label: "OpenAI (Recommended)" });
          }
          if (apiStatus.groq_configured) {
            providers.push({ value: "groq", label: "Groq (Free tier available)" });
          }
          // L∆∞u √Ω: MODEL_CATALOG d√πng key "gemini" (kh√¥ng ph·∫£i "google")
          if (apiStatus.google_configured) {
            providers.push({ value: "gemini", label: "Google (Gemini)" });
          }

          if (providers.length === 0) {
            // Ch∆∞a c√≥ key n√†o: kh√≥a model & hi·ªÉn th·ªã placeholder
            providerSel.innerHTML = `<option value="" disabled>Ch∆∞a c·∫•u h√¨nh API key</option>`;
            providerSel.value = "";
            modelSel.innerHTML = `<option value="" disabled>‚Äî</option>`;
            modelSel.disabled = true;
            // C√≥ th·ªÉ d·ª´ng s·ªõm ph·∫ßn c√≤n l·∫°i
          } else {
            // ƒê·ªï option provider h·ª£p l·ªá
            providers.forEach(p => {
              const opt = document.createElement("option");
              opt.value = p.value;
              opt.textContent = p.label;
              providerSel.appendChild(opt);
            });

            // 4) Fallback cho default_provider
            const canUseDefault =
              apiStatus.default_provider &&
              [...providerSel.options].some(o => o.value === apiStatus.default_provider);
            providerSel.value = canUseDefault ? apiStatus.default_provider : providers[0].value;

            // 5) Fill models theo provider ƒë√£ ch·ªçn + fallback cho model
            modelSel.disabled = false;
            const preselectModel =
              apiStatus.default_model_id || localStorage.getItem("llm_model") || null;

            if (typeof fillModelsFor === "function") {
              fillModelsFor(providerSel.value, preselectModel);

              const hasPreselect =
                preselectModel &&
                [...modelSel.options].some(o => o.value === preselectModel);
              if (!hasPreselect && modelSel.options.length > 0) {
                modelSel.value = modelSel.options[0].value;
              }

              // G·∫Øn listener ƒë·ªïi model khi ƒë·ªïi provider (ch·ªâ 1 l·∫ßn)
              if (!window._providerModelListenerBound) {
                providerSel.addEventListener("change", (e) => {
                  fillModelsFor(e.target.value, null);
                  if (modelSel.options.length > 0) {
                    modelSel.value = modelSel.options[0].value; // fallback model
                  }
                });
                window._providerModelListenerBound = true;
              }
            }
          }

          // 6) Load crawler config
          const cfgRes = await fetch("/api/config", {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
          });
          if (!cfgRes.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c config");
          const config = await cfgRes.json();

          // 7) Map field ƒë√∫ng t√™n
          document.getElementById("dateRangeDays").value =
            config.date_range_days ?? 30;
          document.getElementById("maxArticlesPerSource").value =
            config.max_articles_per_source ?? 50;
          document.getElementById("crawlTimeout").value =
            config.crawl_timeout ?? 30;
          document.getElementById("keywordsConfig").value = JSON.stringify(
            config.keywords ?? {},
            null,
            2
          );
        } catch (err) {
          console.error("Error loading settings:", err);
          showAlert?.("danger", "L·ªói t·∫£i c√†i ƒë·∫∑t", String(err.message || err));
        }
      }

      function updateApiKeyStatus(provider, configured) {
        const statusEl = document.getElementById(provider + "Status");
        if (configured) {
          statusEl.innerHTML =
            '<i class="fas fa-circle text-success me-1"></i>Configured';
        } else {
          statusEl.innerHTML =
            '<i class="fas fa-circle text-danger me-1"></i>Not configured';
        }
      }

      async function validateModel(provider, model) {
        const res = await fetch(
          `/api/models/check?provider=${provider}&model=${encodeURIComponent(
            model
          )}`,
          {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          }
        );
        const data = await res.json();
        if (!res.ok || !data.ok) {
          showAlert(
            "warning",
            "Model kh√¥ng kh·∫£ d·ª•ng",
            `API key c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ model "${model}".`
          );
        }
      }

      on("defaultModel", "change", (e) => {
        const provider = document.getElementById("defaultProvider")?.value;
        validateModel(provider, e.target.value);
      });

      function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling.querySelector("i");

        if (field.type === "password") {
          field.type = "text";
          button.className = "fas fa-eye-slash";
        } else {
          field.type = "password";
          button.className = "fas fa-eye";
        }
      }

      async function updateApiKeys() {
        try {
          const apiKeys = {
            openai_api_key: document.getElementById("openaiApiKey").value,
            groq_api_key: document.getElementById("groqApiKey").value,
            google_api_key: document.getElementById("googleApiKey").value,
            default_provider: document.getElementById("defaultProvider").value,
            default_model: document.getElementById("defaultModel").value,
          };

          // Only send non-empty keys
          if (!apiKeys.openai_api_key) delete apiKeys.openai_api_key;
          if (!apiKeys.groq_api_key) delete apiKeys.groq_api_key;
          if (!apiKeys.google_api_key) delete apiKeys.google_api_key;

          const response = await fetch("/api/api-keys/update", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify(apiKeys),
          });

          const result = await response.json();

          if (response.ok) {
            addActivityLog(
              "API Keys Updated",
              "API keys ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng"
            );

            // Update status indicators
            updateApiKeyStatus("openai", result.status.openai_configured);
            updateApiKeyStatus("groq", result.status.groq_configured);
            updateApiKeyStatus("google", result.status.google_configured);

            // Clear input fields for security
            document.getElementById("openaiApiKey").value = "";
            document.getElementById("groqApiKey").value = "";
            document.getElementById("googleApiKey").value = "";

            // Show success message
            const alertDiv = document.createElement("div");
            alertDiv.className =
              "alert alert-success alert-dismissible fade show mt-3";
            alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Th√†nh c√¥ng!</strong> API keys ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

            const cardBody = document.querySelector(
              "#settingsModal .card-body"
            );
            cardBody.insertBefore(alertDiv, cardBody.firstChild);

            // Auto remove alert after 5 seconds
            setTimeout(() => {
              if (alertDiv.parentNode) {
                alertDiv.remove();
              }
            }, 5000);
          } else {
            throw new Error(result.detail || "Failed to update API keys");
          }
        } catch (error) {
          console.error("Error updating API keys:", error);
          addActivityLog(
            "Error",
            "L·ªói khi c·∫≠p nh·∫≠t API keys: " + error.message,
            "error"
          );

          // Show error message
          const alertDiv = document.createElement("div");
          alertDiv.className =
            "alert alert-danger alert-dismissible fade show mt-3";
          alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>L·ªói!</strong> ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

          const cardBody = document.querySelector("#settingsModal .card-body");
          cardBody.insertBefore(alertDiv, cardBody.firstChild);
        }
      }

      // FIXED: Save settings v·ªõi proper field mapping
      async function saveSettings() {
        try {
          const config = {
            date_range_days: parseInt(
              document.getElementById("dateRangeDays").value
            ),
            max_articles_per_source: parseInt(
              document.getElementById("maxArticlesPerSource").value
            ),
            crawl_timeout: parseInt(
              document.getElementById("crawlTimeout").value
            ),
            keywords: JSON.parse(
              document.getElementById("keywordsConfig").value
            ),
          };

          const response = await fetch("/api/config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify(config),
          });

          if (response.ok) {
            addActivityLog("Settings Updated", "C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t");
            bootstrap.Modal.getInstance(
              document.getElementById("settingsModal")
            ).hide();

            // Reload current config
            await loadCurrentConfig();
          } else {
            throw new Error("Failed to save settings");
          }
        } catch (error) {
          console.error("Error saving settings:", error);
          addActivityLog("Error", "L·ªói khi l∆∞u c√†i ƒë·∫∑t", "error");
        }
      }

      function getFaviconURL(domain) {
        if (!domain) return "https://icons.duckduckgo.com/ip3/example.com.ico";
        return `https://icons.duckduckgo.com/ip3/${domain.replace(/^https?:\/\//, "")}.ico`;
      }

      function renderSelectedChips() {
        const wrap = document.getElementById("pipelineSelectedChips");
        if (!wrap) return;
        wrap.innerHTML = "";

        Array.from(PIPELINE_SELECTED_MEDIA).forEach(id => {
          const item = PIPELINE_ALL_MEDIA.find(s => (sourceKey(s)) === id);
          const label = item?.name ?? item?.domain ?? String(id);
          const chip = document.createElement("span");
          chip.className = "source-chip";
          chip.innerHTML = `${label} <button title="B·ªè ch·ªçn" data-id="${id}">&times;</button>`;
          chip.querySelector("button").addEventListener("click", (e) => {
            PIPELINE_SELECTED_MEDIA.delete(e.currentTarget.dataset.id);
            renderPipelineMediaUI(document.getElementById("pipelineMediaSearch")?.value || "");
          });
          wrap.appendChild(chip);
        });
      }

      function renderPipelineMediaUI(filterText = "") {
        const listWrap = document.getElementById("pipelineMediaList");
        if (!listWrap) return;

        const q = (filterText || "").trim().toLowerCase();
        const filtered = q
          ? PIPELINE_ALL_MEDIA.filter(s =>
            (s.domain || "").toLowerCase().includes(q))
          : PIPELINE_ALL_MEDIA;

        listWrap.innerHTML = "";

        filtered.forEach(s => {
          const id = sourceKey(s);
          const label = s.name ?? s.domain ?? String(id);
          const domain = s.domain ?? "";

          const card = document.createElement("div");
          card.className = "source-card";
          const checked = PIPELINE_SELECTED_MEDIA.has(id);

          card.innerHTML = `
      <img class="favicon" src="${getFaviconURL(domain)}" onerror="this.style.visibility='hidden'">
      <div class="source-meta">
        <div class="source-name text-truncate">${label}</div>
        ${domain ? `<div class="source-domain text-truncate">${domain}</div>` : ""}
      </div>
      <div class="source-actions">
        <div class="toggle-pill ${checked ? "checked" : ""}" role="switch" aria-checked="${checked}" data-id="${id}" title="${checked ? "ƒê√£ ch·ªçn" : "Ch·ªçn"}"></div>
      </div>
    `;

          // Overlay "Max 5" khi ƒë√£ ƒë·ªß limit v√† th·∫ª n√†y ch∆∞a ƒë∆∞·ª£c ch·ªçn
          if (!checked && PIPELINE_SELECTED_MEDIA.size >= PIPELINE_MAX_MEDIA_SOURCES) {
            const overlay = document.createElement("div");
            overlay.className = "limit-badge";
            // overlay.textContent = "ƒê√£ ƒë·ªß 5 ngu·ªìn";
            card.appendChild(overlay);
            card.classList.add("disabled");
          }

          // Toggle handler
          card.querySelector(".toggle-pill").addEventListener("click", (e) => {
            const _id = e.currentTarget.dataset.id;
            if (PIPELINE_SELECTED_MEDIA.has(_id)) {
              PIPELINE_SELECTED_MEDIA.delete(_id);
            } else {
              if (PIPELINE_SELECTED_MEDIA.size >= PIPELINE_MAX_MEDIA_SOURCES) return;
              PIPELINE_SELECTED_MEDIA.add(_id);
            }
            renderPipelineMediaUI(document.getElementById("pipelineMediaSearch")?.value || "");
          });

          listWrap.appendChild(card);
        });

        updatePipelineMediaCounterAndLock();
        renderSelectedChips();
      }

      function updatePipelineMediaCounterAndLock() {
        const cnt = PIPELINE_SELECTED_MEDIA.size;
        const badge = document.getElementById("pipelineMediaCount");
        if (badge) badge.textContent = `${cnt}/${PIPELINE_MAX_MEDIA_SOURCES}`;

        const lockRest = cnt >= PIPELINE_MAX_MEDIA_SOURCES;

        document.querySelectorAll("#pipelineMediaList .source-card").forEach(card => {
          const pill = card.querySelector(".toggle-pill");
          const id = pill?.dataset.id;
          const checked = id ? PIPELINE_SELECTED_MEDIA.has(id) : false;

          // B·∫≠t/t·∫Øt overlay "ƒë√£ ƒë·ªß 5" v·ªõi item CH∆ØA ch·ªçn khi ƒë·ªß limit
          let overlay = card.querySelector(".limit-badge");
          if (lockRest && !checked) {
            if (!overlay) {
              overlay = document.createElement("div");
              overlay.className = "limit-badge";
              card.appendChild(overlay);
            }
            card.classList.add("disabled");
            pill?.setAttribute("aria-checked", "false");
          } else {
            overlay?.remove();
            card.classList.remove("disabled");
            pill?.setAttribute("aria-checked", String(checked));
          }
        });
      }

      function sourceKey(s) {
        return s.reference_name ?? `${s.type}|${s.domain}`;
      }

      async function loadPipelineMediaPicker() {
        const host = document.querySelector('#pipelineMediaList')?.closest('.card, .modal-body')
          || document.querySelector('#configModal .modal-body');
        const search = document.getElementById("pipelineMediaSearch");
        const clearBtn = document.getElementById("pipelineMediaClearBtn");

        [search, clearBtn].forEach(el => el && (el.disabled = true));
        try {
          const listRes = await fetch("/api/media-sources", {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
          });
          if (!listRes.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch ngu·ªìn");
          const list = await listRes.json();
          PIPELINE_ALL_MEDIA = (Array.isArray(list) ? list : []).map(s => ({
            ...s,
            source_key: sourceKey(s)
          }));

          // KH√îI PH·ª§C: ∆∞u ti√™n localStorage -> ƒë·∫øn config t·ª´ backend
          const lsSelected = getSavedSelectedSources();

          // Fix bug: d√πng selected_sources t·ª´ currentConfig thay v√¨ media_sources
          const beSelected = Array.isArray(currentConfig?.selected_sources)
            ? currentConfig.selected_sources
            : [];

          const preselected = (lsSelected.length ? lsSelected : beSelected).slice(0, PIPELINE_MAX_MEDIA_SOURCES);
          PIPELINE_SELECTED_MEDIA = new Set(preselected);

          renderPipelineMediaUI();
          updatePipelineMediaCounterAndLock();

          [search, clearBtn].forEach(el => el && (el.disabled = false));
          if (search && !search._bound) {
            search.addEventListener("input", debounce(() => {
              renderPipelineMediaUI(search.value);
            }, 200));
            search._bound = true;
          }
          if (clearBtn && !clearBtn._bound) {
            clearBtn.addEventListener("click", () => {
              PIPELINE_SELECTED_MEDIA.clear();
              renderPipelineMediaUI(document.getElementById("pipelineMediaSearch")?.value || "");
            });
            clearBtn._bound = true;
          }
        } catch (err) {
          console.error("loadPipelineMediaPicker error:", err);
          showAlert?.("danger", "L·ªói t·∫£i Media Sources", String(err.message || err));
        }
      }

      // Status polling
      function startStatusPolling() {
        if (statusInterval) clearInterval(statusInterval);
        statusInterval = setInterval(loadStatus, 5000);
      }

      function startIntensivePolling() {
        if (!currentSessionId) return;
        // If an SSE connection is already established, do nothing
        if (tasksStreamController) {
          return;
        }
        // Establish SSE stream to get real-time task updates. If SSE fails,
        // connectTasksSSE() will fall back to polling via startIntensivePollingFallback().
        connectTasksSSE();
      }

      function addActivityLog(title, message, type = "info") {
        const log = document.getElementById("activityLog");
        const timestamp = new Date().toLocaleString("vi-VN");

        const logItem = document.createElement("div");
        logItem.className = "timeline-item fade-in";
        logItem.innerHTML = `
                <div class="fw-bold ${type === "error"
            ? "text-danger"
            : type === "warning"
              ? "text-warning"
              : ""
          }">${title}</div>
                <div class="text-muted small">${message}</div>
                <div class="text-muted small"><i class="fas fa-clock me-1"></i>${timestamp}</div>
            `;

        log.insertBefore(logItem, log.firstChild);

        // Keep only last 10 log items
        while (log.children.length > 10) {
          log.removeChild(log.lastChild);
        }
      }

      // Handle page visibility change
      document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
          // Page is hidden, reduce polling frequency
          if (statusInterval) {
            clearInterval(statusInterval);
            statusInterval = setInterval(loadStatus, 30000); // Poll every 30 seconds
          }
        } else {
          // Page is visible, resume normal polling
          if (statusInterval) {
            startStatusPolling();
          }
        }
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if ((e.altKey && e.key.toLowerCase() === "r")) {
          e.preventDefault();
          if (!document.getElementById("runBtn").disabled) runPipeline();
        }
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case "f":
              e.preventDefault();
              document.getElementById("searchInput").focus();
              break;
            case "s":
              e.preventDefault();
              openSettings();
              break;
          }
        }
      });

      console.log("‚úÖ Media Tracker Dashboard loaded successfully!");
    </script>

    <script>
      async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        const response = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await response.json();

        if (response.ok) {
          localStorage.setItem("token", data.access_token);
          sessionStorage.setItem("reloadAfterLogin", "1");
          window.location.replace(window.location.pathname + window.location.search);
          const loginContainer = document.getElementById("loginContainer");
          const dashboardContainer =
            document.getElementById("dashboardContainer");

          // Add fade out animation
          loginContainer.classList.add("fade-out-up");

          // Delay sau animation
          setTimeout(() => {
            loginContainer.style.display = "none";
            dashboardContainer.style.display = "block";
            dashboardContainer.classList.add("fade-in-down");
          }, 700); // Kh·ªõp v·ªõi th·ªùi gian animation
          initializeDashboard();
          await hydrateConfigOnLogin();
          loadInitialData();
          startStatusPolling();
        } else {
          alert("Wrong account or password");
        }
      }

      function logout() {
        localStorage.removeItem("token");
        currentSessionId = null;
        if (statusInterval) {
          clearInterval(statusInterval);
        }
        // ƒê√≥ng SSE stream cho tasks khi ƒëƒÉng xu·∫•t
        closeTasksSSE();

        document.getElementById("loginForm").reset();
        showLogin();

        // ƒê√≥ng modal n·∫øu c√≥
        const modalEl = document.getElementById("logoutModal");
        if (modalEl) {
          const modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) modal.hide();
        }
      }

      function confirmLogout() {
        const modal = new bootstrap.Modal(
          document.getElementById("logoutModal")
        );
        modal.show();
      }

      const text = "WELCOME TO CHICOM SERVICES";
      const target = document.getElementById("typingText");
      let index = 0;

      function typeLetter() {
        if (index < text.length) {
          target.textContent += text.charAt(index);
          index++;
          setTimeout(typeLetter, 100); // T·ªëc ƒë·ªô g√µ: 100ms m·ªói ch·ªØ
        } else {
          // Khi g√µ xong th√¨ ·∫©n thanh g√µ (cursor)
          target.style.borderRight = "none";
        }
      }

      function handleAuthUI() {
        const token = localStorage.getItem("token");
        const loginDiv = document.getElementById("loginContainer");
        const dashboardDiv = document.getElementById("dashboardContainer");

        if (token) {
          loginDiv.style.display = "none";
          dashboardDiv.style.display = "block";
        } else {
          loginDiv.style.display = "block";
          dashboardDiv.style.display = "none";
        }
      }

      async function loadReportList() {
        const tableBody = document.getElementById("reportTableBody");
        tableBody.innerHTML = `
        <tr>
          <td colspan="4" class="text-muted text-center">
            <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
            ƒêang t·∫£i...
          </td>
        </tr>`;
        try {
          const res = await fetch("/api/reports/list", {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
          });
          const reports = await res.json();

          if (!Array.isArray(reports) || reports.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Kh√¥ng c√≥ b√°o c√°o n√†o</td></tr>`;
            return;
          }

          tableBody.innerHTML = "";
          reports.forEach((report, index) => {
            const timeStr = report.generated_at
              ? new Date(report.generated_at).toLocaleString("vi-VN", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              })
              : "Kh√¥ng r√µ";

            const row = `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${report.filename}</td>
                                    <td>${timeStr}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-success" onclick="downloadReportDirectly('${report.filename
              }')">
                                            ‚¨áÔ∏è T·∫£i xu·ªëng
                                        </button>
                                    </td>
                                </tr>
                                `;
            tableBody.insertAdjacentHTML("beforeend", row);
          });
        } catch (err) {
          console.error("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch b√°o c√°o:", err);
          tableBody.innerHTML = `<tr><td colspan="4" class="text-danger text-center">L·ªói khi t·∫£i danh s√°ch</td></tr>`;
        }
      }

      async function downloadReportDirectly(filename) {
        try {
          const response = await fetch(`/api/reports/download/${filename}`, {
            headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
          });
          if (!response.ok) {
            throw new Error("Kh√¥ng th·ªÉ t·∫£i file");
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.style.display = "none";

          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (err) {
          console.error("‚ùå L·ªói khi t·∫£i file:", err);
          alert(
            "Kh√¥ng th·ªÉ t·∫£i b√°o c√°o. Vui l√≤ng ki·ªÉm tra token ho·∫∑c ƒëƒÉng nh·∫≠p l·∫°i."
          );
        }
      }

      window.onload = typeLetter;
    </script>

    <!-- Modal x√°c nh·∫≠n ƒëƒÉng xu·∫•t -->
    <div class="modal fade" id="logoutModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header">
            <h5 class="modal-title">X√°c nh·∫≠n ƒëƒÉng xu·∫•t</h5>
          </div>
          <div class="modal-body">
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              H·ªßy
            </button>
            <button class="btn btn-danger" onclick="logout()">ƒê·ªìng √Ω</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal hi·ªÉn th·ªã file list -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="reportModalLabel">
              üìÑ Danh s√°ch b√°o c√°o ƒë√£ t·∫°o
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>#</th>
                  <th>T√™n b√°o c√°o</th>
                  <th>Th·ªùi gian t·∫°o</th>
                  <th>T·∫£i xu·ªëng</th>
                </tr>
              </thead>
              <tbody id="reportTableBody">
                <tr>
                  <td colspan="4" class="text-muted text-center">
                    ƒêang t·∫£i...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal th√¥ng b√°o ho√†n th√†nh process -->
    <div class="modal fade" id="completionModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Ho√†n th√†nh!</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="mb-0">Qu√° tr√¨nh x·ª≠ l√Ω ƒë√£ ho√†n t·∫•t th√†nh c√¥ng.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">
              ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("show.bs.modal", () => {
          const dialog = modal.querySelector(".modal-dialog");
          if (dialog) {
            dialog.classList.add("animate__animated", "animate__fadeInDown");
          }
        });

        modal.addEventListener("hidden.bs.modal", () => {
          const dialog = modal.querySelector(".modal-dialog");
          if (dialog) {
            dialog.classList.remove("animate__animated", "animate__fadeInDown");
          }
        });
      });
    </script>

    <script>
      const modalCache = {};
      function showModal(id) {
        const el = document.getElementById(id);
        if (!modalCache[id]) modalCache[id] = new bootstrap.Modal(el);
        modalCache[id].show();
      }

      // Khi b·∫•t k·ª≥ modal n√†o ƒë√≥ng, n·∫øu kh√¥ng c√≤n modal ƒëang m·ªü -> unlock body + d·ªçn backdrop
      document.addEventListener('hidden.bs.modal', () => {
        setTimeout(() => {
          if (document.querySelectorAll('.modal.show').length === 0) {
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');
            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
          }
        }, 50); // ƒë·ª£i Bootstrap ho√†n t·∫•t animation r·ªìi m·ªõi d·ªçn
      });
    </script>

    <script>
      async function togglePauseResume() {
        if (!currentSessionId) return;

        const btn = document.getElementById("pauseResumeBtn");
        const isCurrentlyPaused = btn.innerHTML.includes("Resume");

        const endpoint = isCurrentlyPaused
          ? `/api/tasks/${currentSessionId}/resume`
          : `/api/tasks/${currentSessionId}/pause`;

        try {
          await fetch(endpoint, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          loadStatus(); // G·ªçi l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t UI
        } catch (err) {
          console.error(err);
        }
      }
    </script>

    <!-- Configure Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
      <div class=" modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-filter me-2"></i>
              Configure Pipeline
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Date Range Filter -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="fas fa-calendar me-2"></i>
                  Date Range Filter
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-12 col-md-6">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" />
                    <div class="form-text">
                      Leave empty for default (30 days ago)
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" />
                    <div class="form-text">Leave empty for today</div>
                  </div>
                </div>
                <div class="mt-3">
                  <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="setDateRange('today')">
                    Today
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="setDateRange('week')">
                    Last 7 days
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="setDateRange('month')">
                    Last 30 days
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="setDateRange('quarter')">
                    Last 90 days
                  </button>
                </div>
              </div>
            </div>

            <!-- Custom Keywords -->
            <div class="card">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="fas fa-tags me-2"></i>
                  Custom Keywords
                </h6>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <small>
                    <i class="fas fa-info-circle me-1"></i>
                    Customize keywords for each industry. Leave empty to use
                    default keywords.
                  </small>
                </div>

                <div id="keywordContainer">
                  <!-- Industry keyword sections will be generated here -->
                </div>

                <div class="mt-3">
                  <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="addIndustry()">
                    <i class="fas fa-plus me-1"></i>Add Industry
                  </button>
                  <!-- <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="addFile()">
                    <i class="fas fa-plus me-1"></i>Add File (.csv)
                  </button> -->
                  <button type="button" class="btn btn-sm btn-outline-warning" onclick="resetKeywords()">
                    <i class="fas fa-undo me-1"></i>Reset to Default
                  </button>
                </div>
              </div>
            </div>
            <!-- Media Sources (max 5) -->
            <div class="card mt-4" id="pipelineSourcesCard">
              <div class="card-header d-flex align-items-center justify-content-between">
                <h6 class="card-title mb-0">
                  <i class="fas fa-newspaper me-2"></i>
                  Media Sources (t·ªëi ƒëa 5)
                </h6>
                <span class="badge bg-primary" id="pipelineMediaCount">0/5</span>
              </div>
              <div class="card-body">
                <div class="row g-2 mb-3">
                  <div class="col-auto">
                    <input id="pipelineMediaSearch" class="form-control form-control-sm" placeholder="T√¨m ngu·ªìn...">
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="pipelineMediaClearBtn">
                      B·ªè ch·ªçn t·∫•t c·∫£
                    </button>
                  </div>
                </div>

                <div class="media-picker-toolbar">
                  <!-- <span class="counter-badge" id="pipelineMediaCount">0/5</span> -->
                  <div class="selected-chips" id="pipelineSelectedChips"></div>
                </div>

                <div id="pipelineMediaList" class="row row-cols-1 row-cols-md-2 g-2">
                  <!-- S·∫Ω render b·∫±ng JS -->
                </div>

                <small class="text-muted d-block mt-2">
                  Ch·ªçn t·ªëi ƒëa 5 ngu·ªìn. Khi ƒë·ªß 5, c√°c ngu·ªìn c√≤n l·∫°i s·∫Ω t·ª± ƒë·ªông kh√≥a.
                </small>
              </div>
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-secondary action-btn" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>Cancel
            </button>

            <div>
              <button type="button" class="btn btn-success me-2 action-btn" onclick="saveConfigInModal()">
                <i class="fas fa-save me-1"></i>Save Settings
              </button>
              <button type="button" class="btn btn-primary action-btn" onclick="runWithConfig()">
                <i class="fas fa-play me-1"></i>Run with Config
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">C√†i ƒë·∫∑t h·ªá th·ªëng</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- API Keys Section -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="fas fa-key me-2"></i>
                  API Keys Configuration
                </h6>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <small>
                    <i class="fas fa-info-circle me-1"></i>
                    C·∫ßn √≠t nh·∫•t 1 API key ƒë·ªÉ h·ªá th·ªëng ho·∫°t ƒë·ªông.
                    <a href="https://platform.openai.com/api-keys" target="_blank">Get OpenAI Key</a>
                    |
                    <a href="https://console.groq.com/keys" target="_blank">Get Groq Key</a>
                  </small>
                </div>

                <div class="row">
                  <div class="col-12 col-md-6">
                    <div class="mb-3">
                      <label class="form-label">OpenAI API Key</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="openaiApiKey" placeholder="sk-..." />
                        <button class="btn btn-outline-secondary" type="button"
                          onclick="togglePassword('openaiApiKey')">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                      <div id="openaiStatus" class="form-text">
                        <i class="fas fa-circle text-secondary me-1"></i>Not
                        configured
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Groq API Key</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="groqApiKey" placeholder="gsk_..." />
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('groqApiKey')">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                      <div id="groqStatus" class="form-text">
                        <i class="fas fa-circle text-secondary me-1"></i>Not
                        configured
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Google API Key</label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="googleApiKey" placeholder="AIza..." />
                        <button class="btn btn-outline-secondary" type="button"
                          onclick="togglePassword('googleApiKey')">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                      <div id="googleStatus" class="form-text">
                        <i class="fas fa-circle text-secondary me-1"></i>Not configured
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Default Provider</label>
                  <select class="form-select" id="defaultProvider">
                    <option value="openai">OpenAI (Recommended)</option>
                    <option value="groq">Groq (Free tier available)</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Default Model</label>
                  <select class="form-select" id="defaultModel">
                    <!-- s·∫Ω ƒë∆∞·ª£c fill ƒë·ªông theo provider -->
                  </select>
                  <div class="form-text">
                    Ch·ªçn model t∆∞∆°ng ·ª©ng v·ªõi provider.
                  </div>
                </div>

                <div class="d-grid">
                  <button type="button" class="btn btn-primary" onclick="updateApiKeys()">
                    <i class="fas fa-save me-2"></i>
                    Update API Keys
                  </button>
                </div>
              </div>
            </div>

            <!-- Crawler Settings -->
            <div class="card">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="fas fa-cog me-2"></i>
                  Crawler Settings
                </h6>
              </div>
              <div class="card-body">
                <form id="settingsForm">
                  <div class="mb-3">
                    <label class="form-label">Kho·∫£ng th·ªùi gian crawl (ng√†y)</label>
                    <input type="number" class="form-control" id="dateRangeDays" min="1" max="365" value="30" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">S·ªë b√†i t·ªëi ƒëa m·ªói source</label>
                    <input type="number" class="form-control" id="maxArticlesPerSource" min="1" max="1000" value="50" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Timeout (gi√¢y)</label>
                    <input type="number" class="form-control" id="crawlTimeout" min="5" max="300" value="30" />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Keywords (JSON format)</label>
                    <textarea class="form-control" id="keywordsConfig" rows="8"></textarea>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              H·ªßy
            </button>
            <button type="button" class="btn btn-primary" onclick="saveSettings()">
              L∆∞u c√†i ƒë·∫∑t
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>